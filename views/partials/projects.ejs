<div class="row">
  <div class="card col-sm-9">
    <div class="card-body">
    <h1 class="card-title">PROJECTS - <%= projects.length %> <button class="btn border-secondary-subtle" data-bs-toggle="modal" data-bs-target="#projectModal">ADD +</button>
      </h1>

    <div class="modal fade" id="projectModal" tabindex="-1" aria-labelledby="projectModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form  id="projectForm" action="/projects" method = "POST">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectModalLabel">Add Project</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <label for="projName">Project Name:</label>
              <input type="text" id="projName" name="projName"><br><br>
              <label for="projDesc">Description:</label>
              <textarea class="form-control" rows="5" type="projDesc" id="projDesc" name="projDesc"></textarea><br><br>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

              <button name="addNewProject" type="submit" class="btn btn-primary" >Submit</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <% projects.forEach(function(project) { %>
      <div class="card">
        <div class="card-body">
          
          <div class="card-body">
            
            <div class="dropdown float-end">
              <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="20" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                  <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                </svg>
              </button>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <li><button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#editProjectModal-<%= project._id %>">EDIT</button></li>
                <li><button style="color:red" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#deleteProjectModal-<%= project._id %>">DELETE</button></li>
              </ul>
            </div>
          </div>


          <div class="modal fade" id="deleteProjectModal-<%= project._id %>" tabindex="-1" aria-labelledby="deleteProjectModalLabel" aria-hidden="true">
          <div class="modal-dialog">
          <form  id="deleteProjectForm" action="/projects" method = "POST">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="deleteProjectModalLabel">Delete Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Are you sure you want to delete the project "<%=project.name%>"? This action is irreversible.
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button name="deleteProject" type="submit" class="btn btn-danger" value="<%=project._id%>" id="<%=project._id%>" >Delete</button>
              </div>
            </div>
            </form>
            </div>
      </div>

          <div class="modal fade" id="editProjectModal-<%= project._id %>" tabindex="-1" aria-labelledby="editProjectModalLabel" aria-hidden="true">
          <div class="modal-dialog">
          <form  id="editProjectForm" action="/projects" method = "POST">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editProjectModalLabel">Edit Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <label for="projName">Project Name:</label>
                <input type="text" id="projName" name="projName" value="<%=project.name%>"required><br><br>
                <label for="projDesc">Description:</label>
                <textarea class="form-control" rows="5" type="projDesc" id="projDesc" name="projDesc" required><%=project.description%></textarea><br><br>
              </div>
              <div class="modal-footer">
                
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button name="editProject" type="submit" class="btn btn-primary" value="<%=project._id%>" id="<%=project._id%>" >Save</button>
              </div>
            </div>
            </form>
            </div>
      </div>
      <h4 class="card-title"><%= project.name %></h4>
      <p><%= project.description %></p>
      <div class="row">
        <div class="col-sm-auto">
          <div class="card-title">Lead:</div>
            <div class="card-body bg-secondary-subtle" ondrop="drop(event)" ondragover="allowDrop(event)">
              <%
              //kittle's code
                let empty = true;
                project.members.forEach(function(member) {
                  let person=personnel.find(person=> person._id === member.id)
                  if (person.projects) {
                    if (person.projects.find(assignment=> assignment.id === project._id).role == 'Lead' ){
                      empty = false %>
                      <button id="<%= person._id %>-button" draggable="True" class="btn bg-light border-secondary-subtle noDrop" ondragstart="drag(event)">
                        <strong><%= person.firstName+' '+person.lastName %></strong>
                        <% 
                        // count how many projects each person has and determine their color
                        let total = utils.countProjects(person)
                        let color = utils.getColor(total)
                        %>
                        <span class="badge bg-<%=color%>"><%= total %></span>
                      </button>
                  <%  }}});
                if (empty) { %>
                  <button  data-bs-toggle="modal" data-bs-target="#addLeadModal" class="btn bg-light noDrop">ADD LEAD +</button>
                  <div class="modal fade" id="addLeadModal" tabindex="-1" aria-labelledby="addLeadModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                    <form  id="leadForm" action="/projects" method = "POST">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="leadModalLabel">Add Lead</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                        
                          <%
                          project.members.forEach(function(member) {
                          person=personnel.find(person=> person._id === member.id)
                          if (person.projects) { %>
                          <input class="form-check-input" name="checkLead" type="radio" value="<%=person._id%>" id="<%=person._id%>" >
                              <label class="form-check-label" style="width: 100%; text-align: left; position: relative; z-index: 1000" for="<%=person._id%>">
                                <%= person.firstName+' '+person.lastName %>
                                <% 
                                // count how many projects each person has and determine their color
                                let total = utils.countProjects(person)
                                
                                let color = utils.getColor(total)
                              %>
                              <span class="badge bg-<%=color%>" style="float: right;">
                                <%= total %>
                              </span>
                              </label> 
                              <% }}) %>

                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

                          <button name="addNewLead" value="<%=project._id%>" id="<%=project._id%>" type="submit" class="btn btn-primary" >Submit</button>
                        </div>
                      </div>
                    </form>
                    </div>
                  </div>

              <% } %>
            </div>
          </div>
          <div class="col-sm-auto">
            <div class="card-title">Members:</div>
            <div class="card-body bg-secondary-subtle" ondrop="drop(event)" ondragover="allowDrop(event)">
              <%
                empty = true;
                project.members.forEach(function(member) {
                  let person=personnel.find(person=> person._id === member.id)
                  if (person.projects) {
                    if (person.projects.find(assignment=> assignment.id === project._id).role != 'Lead') { empty = false %>
                      <button id="<%= person._id %>-button" draggable="True" class="btn bg-light border-secondary-subtle noDrop" ondragstart="drag(event)">
                        <strong><%= person.firstName+' '+person.lastName %></strong>
                <% 
                  // count how many projects each person has and determine their color
                  let total = utils.countProjects(person)
                  
                  let color = utils.getColor(total)
                %>
                        <span class="badge bg-<%=color%>">
                          <%= total %>
                        </span>
                      </button>
                      <%  } 
                    }
                   })
                   %>
                     <button class="btn bg-light noDrop" data-bs-toggle="modal" data-bs-target="#p2Modal-<%=project._id%>">+</button>

                    <div class="modal fade" id="p2Modal-<%=project._id%>" tabindex="-1" aria-labelledby="p2ModalLabel-<%=project._id%>" aria-hidden="true">
                      <div class="modal-dialog">

                      <form action="/projects" method="POST">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="p2ModalLabel-<%=project._id%>"  >Add Person to <%=project.name%></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>                          
                          <div class="modal-body">                           
                            <% 
                            
                            personnel.forEach(function(person) { if (person.projects) {%>
                            <div class="form-check" method="POST" action="/projects" >
                              <input class="form-check-input" name="checkPerson" type="checkbox" value="<%=person._id%>" id="<%=person._id%>" >
                              
                              <label class="form-check-label" style="width: 100%; text-align: left; position: relative; z-index: 1000" for="<%=person._id%>">
                                <%= person.firstName+' '+person.lastName %>
                                <% 
                                // count how many projects each person has and determine their color
                                let total = utils.countProjects(person)
                                
                                let color = utils.getColor(total)
                              %>
                              <span class="badge bg-<%=color%>" style="float: right;">
                                <%= total %>
                              </span>
                              </label>      
                            </div>
                          <%}
                          if(!person.projects){ %>
                            <div class="form-check">
                              <input name="checkPerson" class="form-check-input" type="checkbox" value="<%=person._id%>" id="<%=person._id%>">
                              <label class="form-check-label" style="width: 100%; text-align: left; position: relative; z-index: 1000" for="<%=person._id%>">
                                <%= person.firstName+' '+person.lastName %>
                              <span class="badge bg-primary" style="float: right;">
                                    0
                                  </span>
                              </label>      
                            </div>
                            
                            <% }})%>                         

                          
                            
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button name="addPersonnelToProject" value="<%=project._id%>" id="<%=project._id%>"  type="submit" class="btn btn-primary">Submit</button>
                          </div>
                        </div>
                      </form>

                      </div>
                    </div>
                     


            </div>
          </div>
        </div>
        </div>
      </div>
      <% }) %>
    </div>
  </div>
  